<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<title>中央極限定裡實驗體驗</title>
<meta charset="UTF-8">
<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-1.11.0.min.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<style>
.chart rect {
  fill: lightblue;
}

.chart text {
  fill: white;
  font: 10px sans-serif;
  text-anchor: end;
}
.axis path,
.axis line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges;
}

.axis text {
    fill:black;
    font-family: sans-serif;
    font-size: 14px;
}
.draggable{
    cursor:move;
}
</style>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="//cdn.jsdelivr.net/jstat/1.3.0/jstat.min.js"></script>

</head>
<body>
    <p>
        <label >母體元素</label>
        <input type="text" id="population" value="2,4,6,8,10,30" size="80"></input>
    </p>
    <p>
        <label >抽樣樣本數</label>
        <input type="text" size="5" id="samplesize" min="1" max="10000" step=1 value="10">
        <label >實驗次數</label>
        <input type="text" size="5" id="replication" min="1" max="10000" value="1000">
        <label >組數</label>
        <input type="text" size="5" id="noOfPartition" min="1" max="10000" value="25">
        <!--<input type="range" id='drag' min="1" max="10000" value="10" onmousemove="d3.select('#test').html(d3.select('#drag').node().value);">
        <label id='test'></label> -->
        <button onclick="histo()">模擬</button>
        <input type='radio' name='plottype' value='cdf' checked='true' onchange='togglecdf()'>累積相對次數分配
        <input type='radio' name='plottype' value='pdf' onchange='togglecdf()'>次數分配
    </p>
    <p>
        <label>母體\(\mu:\)</label>
        <label id="mu">未算</label>
        <label>, 母體\(\sigma:\)</label>
        <label id="sigma">未算</label>
        <label>, 樣本平均的期望值:</label>
        <label id="samplemu">未算</label>
        <label>, 樣本平均的標準差:</label>
        <label id="samplesigma">未算</label><br>
        <label>上限:</label>
        <label id="upperlimit">未算</label>
        <label>, 近似機率:</label>
        <label id="aproxprob">未算</label>
        <label>, 實際頻率:</label>
        <label id="frequency">未算</label>
        <label>, 實際頻率-近似機率:</label>
        <label id="diff">未算</label>
    </p>
    <p id="histogram">
    <svg class="chart"></svg>
    </p>
<script>
    var values,x;
    var cuts=500;
    var arr,n,replication,size,mu,sigma,samplemu,samplesigma,left,right;
    var xScale,yScale,sScale,xinverse,pScale;
    function sampleMeanWithReplacement(arr, size, replication) {
        var buf = [];
        for (var j = 0; j < replication; j++) {
            var sum = 0;
            for (var i = 0; i < size; i++) {
                var ind = Math.floor(Math.random() * arr.length);
                sum = sum + arr[ind];
            }
            buf.push(sum / size);
        }
        return buf;
    }
    function countFrequency(data,left,right,bins){
        var res=[];
        for (var i = 0; i < bins; i++) {
            res.push({member:[]});
        }
        var step=(right-left)/bins;
        for (var i = 0; i < data.length; i++) {
            var ind = Math.ceil((data[i] - left) / step);
            if (ind>=bins) ind=bins;
            if (ind==0) ind=1;
            ind=ind-1;
            res[ind].member.push(data[i]);
        }
        for (var i = 0; i < bins; i++) {
            res[i].tips=res[i].member.toString();
        }
        return res;
    }
    function standard(x,mu,sigma){
        return (x-mu)/sigma;
    }
    function relativefrequency(x){
        var c=0;
        for (var i=0;i<values.length;i++){
            if (values[i]<=x)
                c=c+1;
            else
                break;
        }
        return c/values.length;
    }
    function showdiff(x){
      d3.select('#upperlimit').text(x.toPrecision(4));
      d3.select('#aproxprob').text(jStat.normal.cdf(standard(x,samplemu,samplesigma),0,1).toPrecision(4));
      d3.select('#frequency').text(relativefrequency(x).toPrecision(4));
      var diff=(d3.select('#frequency').text()-
           d3.select('#aproxprob').text()).toPrecision(4);
      d3.select('#diff').text(diff);
      if (diff>0) 
        d3.select('#diff').style('color','blue');
      else
        d3.select('#diff').style('color','green');
    }
    function histo() {
        // Generate a Bates distribution of 10 random variables.
        //var arr = d3.select('#population').attr('value').split(',');
        arr = d3.select('#population').node().value.split(',');
        for (i = 0; i < arr.length; i++) arr[i] = parseFloat(arr[i]);
        //var n = parseInt(d3.select('#noOfPartition').attr('value'));
        n = parseInt(d3.select('#noOfPartition').node().value);
        //var replication = parseInt(d3.select('#replication').attr('value'));
        replication = parseInt(d3.select('#replication').node().value);
        //var size = parseInt(d3.select('#samplesize').attr('value'));
        size = parseInt(d3.select('#samplesize').node().value);
        values = sampleMeanWithReplacement(arr, size, replication);
        values=values.sort(function(a,b){return a-b;});
        //left=d3.min(arr);
        //right=d3.max(arr);
        left=d3.min(values);
        right=d3.max(values);
        var data = countFrequency(values,left,right,n);
        mu=d3.mean(arr);
        sigma=d3.deviation(arr)*Math.sqrt((arr.length-1)/arr.length);
        samplemu=mu;
        samplesigma=sigma/Math.sqrt(size);
        d3.select('#mu').text(''+mu.toPrecision(4));
        d3.select('#sigma').text(''+sigma.toPrecision(4));
        d3.select('#samplemu').text(''+samplemu.toPrecision(4));
        d3.select('#samplesigma').text(''+samplesigma.toPrecision(4));
        var width = 960, height = 500;
        var padding=70;
        var maxy=d3.max(data, function (d) { return d.member.length; });
        var miny=d3.min(data, function (d) { return d.member.length; });
        yScale = d3.scale.linear()
                    //.domain([0,maxy])
                    .domain([0,1])
                    .range([height-padding, padding]);
        pScale = d3.scale.linear()
                    .domain([0,1])
                    .range([height-padding, padding]);
        xScale=d3.scale.linear()
            .domain([left,right])
            .range([padding,width-padding]);
        xinverse=d3.scale.linear()
            .range([left,right])
            .domain([padding,width-padding]);
        sScale=d3.scale.linear()
            .domain([standard(left,samplemu,samplesigma),
                standard(right,samplemu,samplesigma)])
            .range([padding,width-padding]);
        var chart = d3.select(".chart")
                .attr("width", width)
                .attr("height", height);

        chart.selectAll("g").remove();

        var barWidth = (width-2*padding) / data.length;
        if (barWidth<0.5) barWidth=0.5;
        var step=(right-left)/data.length;
        var bar = chart.selectAll("g")
          .data(data)
          .enter().append("g")
          .attr("transform", function (d, i) { return "translate(" +
            xScale(left+i*step) + ",0)"; });
        //var bwinsd=(d3.max(arr)-d3.min(arr))/n/samplesigma;
        var bwinsd=(right-left)/n/samplesigma;
        bar.append("rect").attr('class','pdf')
          .style('visibility',
            d3.select('input[name="plottype"]:checked').node().value=='pdf'?'visible':'hidden')
          //.attr("y", function (d) { return yScale(d.member.length); })
          .attr("y", function (d) { 
              return yScale(d.member.length/values.length/bwinsd); 
            })
          .attr("height", function (d) { return height-padding - 
              yScale(d.member.length/values.length/bwinsd); })
          .attr("width", barWidth)
          .append('svg:title')
          .text(function(d){return d.tips;});
        chart.append('g').append("text")
            .attr("text-anchor","start").attr('class','pdf')
            .attr("x",0).attr("y",0).attr('transform','matrix(0,-1,1,0,'+(width-20)+','+height/2+')')
            .style('visibility',
              d3.select('input[name="plottype"]:checked').node().value=='pdf'?'visible':'hidden')
            //.attr("x",0).attr(y,6).attr('transform','rotate(-90)')
            //.attr('transform','translate(30,'+(height/2)+')')
            .style('fill','black').style('font-size','14px')
            .text("次數");
        var fScale= d3.scale.linear()
                    .domain([0,bwinsd*values.length])
                    .range([height-padding, padding]);
        var fAxis=d3.svg.axis()
            .scale(fScale).orient('right');
        chart.append('g')
            .attr("class","axis pdf")
            .style('visibility',
              d3.select('input[name="plottype"]:checked').node().value=='pdf'?'visible':'hidden')
            .attr('transform','translate('+xScale(right)+','+(0)+')')
            .call(fAxis);

        var pdfpoints="";
        var step2=(width-2*padding)/300;
        var multiplier=1/Math.sqrt(2*Math.PI);
        for ( var i=0;i<=300;i++){
            var x0=padding+i*step2;
            var s0=standard(xinverse(x0),samplemu,samplesigma);
            //pdfpoints=pdfpoints+x0+' '+
            //  (yScale(jStat.normal.pdf(s0,0,1)*maxy/multiplier));
            pdfpoints=pdfpoints+x0+' '+
              (yScale(jStat.normal.pdf(s0,0,1)));
            if (i<300) {
                pdfpoints=pdfpoints+',';
            }
        }
        chart.append('g').append('polyline').style('fill','none')
             .style('stroke','green').style('stroke-width',2).attr('class','pdf')
             .style('visibility',
               d3.select('input[name="plottype"]:checked').node().value=='pdf'?'visible':'hidden')
             .attr('id',"standardpdf").style('opacity','0.7')
             .attr('points',pdfpoints);

        chart.append('g').append("text")
            .attr("text-anchor","middle")
            .attr("x",width/2).attr("y",height-25)
            .style('fill','black').style('font-size','14px')
            .text("量尺：母體原始資料");
        var xAxis=d3.svg.axis()
            .scale(xScale)
            .orient('bottom');
        chart.append('g')
            .attr("class","axis")
            .attr('transform','translate('+0+','+(height-padding)+')')
            .call(xAxis);

        chart.append('g').append("text")
            .attr("text-anchor","start").attr('class','cdf')
            .attr("x",0).attr("y",0).attr('transform','matrix(0,-1,1,0,20,'+height/2+')')
            .style('visibility',
              d3.select('input[name="plottype"]:checked').node().value=='cdf'?'visible':'hidden')
            //.attr("x",0).attr(y,6).attr('transform','rotate(-90)')
            //.attr('transform','translate(30,'+(height/2)+')')
            .style('fill','black').style('font-size','14px')
            .text("機率");

        var pAxis=d3.svg.axis()
            .scale(pScale).orient('left');
        chart.append('g')
            .attr("class","axis cdf")
            .style('visibility',
              d3.select('input[name="plottype"]:checked').node().value=='cdf'?'visible':'hidden')
            .attr('transform','translate('+xScale(left)+','+(0)+')')
            .call(pAxis);

        chart.append('g').append("text")
            .attr("text-anchor","middle")
            .attr("x",width/2).attr("y",40)
            .style('fill','black').style('font-size','14px')
            .html("量尺：樣本平均標準差為單位");
        var sAxis=d3.svg.axis()
            .scale(sScale)
            .orient('top');
        chart.append('g')
            .attr("class","axis")
            .attr('transform','translate('+0+','+(padding)+')')
            .call(sAxis);
        var standardpoints="";
        var experimentpoints="";
        var step1=(width-2*padding)/300;
        for ( var i=0;i<=300;i++){
            var x0=padding+i*step1;
            var s0=standard(xinverse(x0),samplemu,samplesigma);
            standardpoints=standardpoints+x0+' '+pScale(jStat.normal.cdf(s0,0,1));
            if (i<300) {
                standardpoints=standardpoints+',';
            }
        }
        var startvalue=values[0];
        experimentpoints=experimentpoints+xScale(startvalue)+' '+pScale(0)+' '; 
        experimentpoints=experimentpoints+xScale(startvalue)+' '+pScale(relativefrequency(startvalue))+' '; 
        for ( var i=1;i<values.length;i++){
            var x0=values[i];
            if (x0<=startvalue) continue;
            experimentpoints=experimentpoints+xScale(x0)+' '+pScale(relativefrequency(startvalue))+' '; 
            startvalue=x0;
            experimentpoints=experimentpoints+xScale(startvalue)+' '+pScale(relativefrequency(startvalue))+' ';
        }

        chart.append('g').append('polyline').style('fill','none')
             .style('stroke','green').style('stroke-width',2).attr('class','cdf')
             .style('visibility',
               d3.select('input[name="plottype"]:checked').node().value=='cdf'?'visible':'hidden')
             .attr('id',"standardcdf").style('opacity','0.7')
             .attr('points',standardpoints);
        chart.append('g').append('polyline').style('fill','none')
             .style('stroke','blue').style('stroke-width',2).attr('class','cdf')
             .style('visibility',
               d3.select('input[name="plottype"]:checked').node().value=='cdf'?'visible':'hidden')
             .attr('id',"experimentcdf").style('opacity','0.7')
             .attr('points',experimentpoints);
        var drag=d3.behavior.drag()
                            .on('drag',function(d,i){
                               if (d3.event.x<padding) d3.event.x=padding;
                               if (d3.event.x>width-padding) 
                                  d3.event.x=width-padding;
                               d3.select(this).attr('cx',d3.event.x);
                               line.attr('x1',d3.event.x)
                                   .attr('x2',d3.event.x);
                               x=xinverse(d3.event.x);
                               showdiff(x);
                            });
        var cut=chart.append('g')
        cut.append('circle').attr('cx',sScale(0)).attr('cy',padding-8)
                            .attr('r','8').attr('fill','red')
                            .attr('opacity','0.8')
                            .attr('class','draggable')
                            .call(drag);
        var line=cut.append('line').attr('x1',sScale(0)).attr('y1',padding)
                            .attr('x2',sScale(0))
                            .attr('y2',height-padding)
                            .attr('stroke','red');
        showdiff(samplemu);
    }
    function togglecdf(){
      if (d3.select('input[name="plottype"]:checked').node().value=='cdf'){
          d3.selectAll('.cdf').each(function(d,i){
            d3.select(this).style('visibility','visible');
          })
          d3.selectAll('.pdf').each(function(d,i){
            d3.select(this).style('visibility','hidden');
          })
      } else {
          d3.selectAll('.cdf').each(function(d,i){
            d3.select(this).style('visibility','hidden');
          })
          d3.selectAll('.pdf').each(function(d,i){
            d3.select(this).style('visibility','visible');
          })
      }
    }
</script>        
</body>
</html>
